const core = require('@actions/core');
const github = require('@actions/github');
const httpClient = require("@actions/http-client");
const axios = require("axios");
const fs = require("fs");
var cors = require('cors');


process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
//const wafAddress = core.getInput('waf-address');
//const policyFilePath = core.getInput('policy-filepath');
// const username = core.getInput('username');
// const password = core.getInput('password');
//const fileSize = core.getInput('policy-file-size');
//const policyName = 'AppPolicy01';//core.getInout('policy-name');

const wafAddress = "prod-web-weatherf5.azurewebsites.net";


main();



async function main() {
    try {

        await vulnerability_scan();
        await trusted_traffic();


    } catch (error) {
        core.setFailed(error.message);
        core.setFailed(`Error - Github Actions failure: ${error}`);
    }
}

async function trusted_traffic() {
    //json
    await send_request('get', `https://${wafAddress}/files/file.json`, {},{});
    
    //yml
    await send_request('get', `https://${wafAddress}/files/file.yml`, {},{});

    //bak
    await send_request('get', `https://${wafAddress}/files/file.json`, {},{});

}

async function vulnerability_scan() {
      //XSS
      await send_request('post', `https://${wafAddress}/api/WeatherForecast`, { "Content-Type":"application/json" }, 
      {"description":"<script>alert(\"XSS3\")</script>" });

      //FTP
      await send_request('get', `https://${wafAddress}/ftp/package.json.bak%2500.md`, {},{});
      
      //Login
      await send_request('post', `https://${wafAddress}/index.html?username=1'%20or%20'1'%20=%20'1&password=1'%20or%20'1'%20=%20'1`, {},{});
      
      //PW
      await send_request('post', `https://${wafAddress}/rest/user/change-password?current=abcde&new=slurmCl4ssic&repeat=slurmCl4ssic`, {},{});

}

async function send_request(method, url, headers, body) {
    console.log(`request to: ${url}`);

    var config = {
        method: method,
        url: url,
        headers: headers,
        body
    };

    const requestData = {
        method,
        body
    };
    
    try {
        const instance = axios.create(config);
        const response = await instance.request(requestData);
        console.log("sukces");
    }
    catch(ex) {
        console.log("pora≈ºka: " + ex.message);
    }
    
}
